# SmartResearch：技术深度解析

## 1. 简介

SmartResearch 是基于 **学习与思考链（Chain of Learning & Thinking, CoLT）** 原理构建的 AI 助手。与传统 AI 交互模式不同，其核心设计围绕持续自强化循环：`[思考] → [搜索] → [学习] → [存储] → [重复]`。

本文档提供了项目架构、核心工作流以及交互式命令行界面（CLI）技术细节的全面概述。

## 2. 核心架构

项目采用模块化架构，将用户界面、应用逻辑和 AI 交互分离：

- **入口点 (`bin/smart_research`)**：加载主库并启动命令行界面的 Ruby 脚本

- **主库 (`lib/smart_research.rb`)**：作为中央枢纽，加载所有依赖（包括 `SmartPrompt` 和 `SmartAgent` 库），定义启动应用的 `SmartResearch::CLI` 类

- **应用协调器 (`lib/smart_research/application.rb`)**：用户界面核心组件：
  - **UI 布局**：组合 `Content`、`Sidebar`、`InputArea` 等组件
  - **引擎初始化**：配置 `SmartPrompt::Engine`（LLM 通信）和 `SmartAgent::Engine`（代理工作流管理）
  - **事件处理**：根据用户输入协调代理和工作进程调用

- **代理模块 (`agents/`)**：高级控制器，负责协调完成用户请求的步骤，决定下一步操作（调用工作者、执行工具等）

- **工作者模块 (`workers/`)**：直接与大语言模型（LLM）交互的"思考者"，将代理提供的上下文与定义角色的系统提示（`sys_msg`）结合，向 LLM 发送请求获取响应或工具调用建议

## 3. `smart_bot` 工作流：代理与工作者协作

`smart_bot` 是主要交互实体，其逻辑分离为代理和工作者：

1. **请求发起**：用户输入查询由 `Application` 路由到 `:smart_bot` 代理
2. **代理进入循环**：启动 `while` 循环持续处理工具调用需求
3. **代理调用工作者**：传递用户查询和工具访问权限
4. **工作者交互 LLM**：通过 `sys_msg` 定义助手角色，发送用户查询
5. **LLM 决策**：
   a. **请求工具**：返回结构化工具调用指令（如网络搜索）
   b. **提供最终答案**：直接生成响应
6. **代理执行或退出**：
   a. **工具调用**：执行指定工具，将输出作为新上下文重复循环
   b. **最终响应**：终止循环
7. **用户响应**：代理将最终答案返回 `Application` 并显示在 CLI

## 4. 基于 `ruby_rich` 的交互式 CLI

CLI 采用动态响应式界面：

- **组件化布局**：通过 `Root`、`Main`、`Sidebar` 等组件构建网格布局
- **实时渲染**：`RubyRich::Live.start` 管理终端屏幕，维持 24fps 渲染循环
- **声明式更新**：通过修改绑定数据（如 `content_panel.content`）触发界面更新，引擎自动处理局部重绘

这种现代声明式方法使复杂 TUI（文本用户界面）的构建和维护更加结构化和可维护。